pipeline {
    agent {label 'master'}

    stages {
        stage('CI') {
            steps {
                git 'https://github.com/mahmoud254/jenkins_nodejs_example'
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'MY_PASS', usernameVariable: 'MY_USER' )]) {
                sh '''
                  echo username is ${MY_USER}
                  docker login -u ${MY_USER} -p ${MY_PASS}
                  docker build . -f dockerfile -t ahmednasrhassan/nodeapp:v1.0
                  docker push ahmednasrhassan/nodeapp:v1.0
                '''
              }

            }
        }
        
        stage('CD') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'MY_PASS', usernameVariable: 'MY_USER' )]) {
                sh '''
                  docker login -u ${MY_USER} -p ${MY_PASS}
                  docker run -d -p 3333:3000 ahmednasrhassan/nodeapp:v1.0
                '''
                }
            }
            
            post {
                success {
                    slackSend (color: '#34ebc9', message: 'Building Success ya Nasr, check it from ' + BUILD_URL)
                }
                
                failure {
                    slackSend (color: '#eb349e', message: 'Building Failed ya Nasr, check it from ' + BUILD_URL)
                }
            }
        }
    }
}
